<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gyan Mandala Nepal — Learning Portal</title>
  <meta name="description" content="Interactive learning portal — classes, subjects, lessons for Gyan Mandala Nepal." />
  <style>
    /* =========================
       Design tokens & base
       ==========================*/
    :root{
      --bg-a:#f7fbff;
      --bg-b:#e9f6fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent-red:#B03A2E;      /* Nepal-inspired */
      --accent-saffron:#FF8C2A;
      --accent-blue:#0B6FA4;
      --accent-green:#2AA87A;
      --radius:14px;
      --shadow-lg: 0 18px 50px rgba(8,18,40,0.12);
      --soft: 0 8px 30px rgba(12,34,56,0.06);
      --ease: cubic-bezier(.22,.9,.38,1);
      --max-width:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background: linear-gradient(160deg,var(--bg-a),var(--bg-b));
      color:#071225;
    }

    /* =========================
       Header / Logo (top-right)
       ==========================*/
    header{
      position:relative;
      padding:14px 20px;
      background: linear-gradient(0deg, rgba(255,255,255,0.55), rgba(255,255,255,0.45));
      backdrop-filter: blur(6px);
      box-shadow: var(--soft);
      z-index:40;
    }
    .logo{
      position:absolute;
      right:18px;
      top:18px;            /* slightly lowered for visual balance */
      width:72px;          /* small */
      border-radius:10px;
      cursor:pointer;
      transition: transform .18s var(--ease), box-shadow .18s var(--ease);
    }
    .logo:focus, .logo:hover{ transform: translateY(-2px) scale(1.02); box-shadow:0 10px 30px rgba(11,111,164,0.09); }

    main{flex:1; width:100%; max-width:var(--max-width); margin:18px auto; padding:0 20px 90px;} /* footer space */

    /* =========================
       Pages & transitions
       ==========================*/
    .page{ display:none; opacity:0; transform: translateY(8px); transition: all .42s var(--ease); }
    .page.active{ display:block; opacity:1; transform: translateY(0); }

    .page-enter{ animation: slideIn .36s var(--ease) forwards; }
    .page-exit{ animation: slideOut .28s var(--ease) forwards; }
    @keyframes slideIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
    @keyframes slideOut{ from{opacity:1; transform:translateY(0);} to{opacity:0; transform:translateY(-8px);} }

    /* =========================
       Animated Welcome (3 lines)
       ==========================*/
    .welcome{
      margin-top:44px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .welcome-line{
      font-weight:800;
      line-height:1;
      text-align:center;
      font-size:clamp(28px,5.6vw,48px);
      opacity:0;
      transform: translateY(12px);
      animation: fadeUp .56s var(--ease) forwards;
    }
    .w1{ color: var(--accent-red); animation-delay:.12s; letter-spacing:-0.6px;}
    .w2{ color: var(--accent-saffron); animation-delay:.34s;}
    .w3{ color: var(--accent-blue); animation-delay:.58s;}
    @keyframes fadeUp{ to{opacity:1; transform:translateY(0);} }

    .subtitle{ color:var(--muted); font-size:16px; text-align:center; max-width:780px; margin-top:8px; }

    .hero-actions{ margin-top:20px; display:flex; gap:12px; justify-content:center; align-items:center; }

    .btn{
      padding:12px 18px;
      border-radius:12px;
      border:0;
      cursor:pointer;
      font-weight:700;
      transition: transform .12s var(--ease), box-shadow .12s var(--ease);
    }
    .btn-primary{ background: linear-gradient(90deg,var(--accent-saffron),var(--accent-red)); color:white; box-shadow:0 10px 30px rgba(176,58,46,0.12); }
    .btn-primary:hover{ transform: translateY(-3px); box-shadow: 0 18px 42px rgba(176,58,46,0.14); }
    .btn-ghost{ background:transparent; border:2px solid rgba(12,34,56,0.06); color:var(--accent-blue); }

    /* =========================
       Card / Form (bigger, accessible)
       ==========================*/
    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding:24px;
      box-shadow: var(--shadow-lg);
      margin:26px auto;
      max-width:880px;
    }
    h2{ margin:0; font-size:20px; }
    .muted{ color:var(--muted); }

    form{ display:flex; flex-wrap:wrap; gap:14px; margin-top:12px; align-items:flex-start; }
    .field{ display:flex; flex-direction:column; gap:8px; min-width:220px; width:calc(50% - 16px); }
    .field.full{ width:100%; }
    label{ font-size:14px; color:var(--muted); font-weight:700; }
    input[type="text"], select{
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #e6eef7;
      font-size:15px;
      outline:none;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease);
      background:linear-gradient(180deg,#fff,#fbfdff);
    }
    input:focus, select:focus{ box-shadow:0 12px 30px rgba(11,111,164,0.06); border-color:#cbe8ff; }

    /* =========================
       Breadcrumb & lessons header
       ==========================*/
    .breadcrumb{ display:flex; gap:10px; align-items:center; color:var(--muted); margin-bottom:12px; font-size:14px; }
    .breadcrumb a{ color:var(--accent-blue); text-decoration:none; font-weight:700; cursor:pointer; }

    .lessons-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 8px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(250,250,250,0.9));
      border: 1px solid rgba(0,0,0,0.03);
      margin-bottom:12px;
    }
    .lessons-header .left{ font-weight:700; color:#111; }
    .lessons-header .right{ font-weight:900; color:var(--accent-red); text-align:right; }

    /* small descriptive subtext */
    .lessons-sub{ color:var(--muted); font-size:13px; margin-bottom:6px; }

    /* =========================
       Lessons Grid & buttons
       ==========================*/
    .lessons-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
      margin-top:6px;
    }
    @media (max-width:1000px){ .lessons-grid{ grid-template-columns: repeat(3,1fr); } }
    @media (max-width:700px){ .lessons-grid{ grid-template-columns: repeat(2,1fr); } }

    .lesson-btn{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      height:84px;
      border-radius:12px;
      background:linear-gradient(180deg,#fff,#fbfdff);
      border: 1px solid rgba(0,0,0,0.04);
      font-weight:700;
      font-size:16px;
      cursor:pointer;
      color:#071225;
      box-shadow: var(--soft);
      transition: transform .12s var(--ease), box-shadow .12s var(--ease), background .12s var(--ease);
      overflow:hidden;
    }
    .lesson-btn:hover{ transform: translateY(-6px) scale(1.02); box-shadow: 0 22px 48px rgba(12,34,56,0.09); }
    .lesson-btn:focus{ outline: 3px solid rgba(11,111,164,0.12); outline-offset:3px; }

    /* ripple animation */
    .ripple {
      position:absolute; border-radius:50%; transform:scale(0); animation: ripple .6s linear; background: rgba(11,111,164,0.12);
    }
    @keyframes ripple { to { transform: scale(4); opacity:0; } }

    /* subject accent on lessons page - subtle top border color */
    .lessonsPage-subject-maths .lessons-header{ border-top:4px solid #4a90e2; }
    .lessonsPage-subject-english .lessons-header{ border-top:4px solid #ff9a3d; }
    .lessonsPage-subject-science .lessons-header{ border-top:4px solid #2aa87a; }
    .lessonsPage-subject-social .lessons-header{ border-top:4px solid #ec5a9a; }
    .lessonsPage-subject-nepali .lessons-header{ border-top:4px solid #8b1f1f; }
    .lessonsPage-subject-hamro .lessons-header{ border-top:4px solid #cc6600; }

    /* =========================
       Modal overlay & footer
       ==========================*/
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(8,12,20,0.42); z-index:80; }
    .overlay.open{ display:flex; }
    .modal{ background: #fff; border-radius:12px; padding:18px; width:min(680px,92%); box-shadow: 0 28px 80px rgba(8,18,40,0.22); }
    .modal h3{ margin:0; }
    .modal .meta{ color:var(--muted); font-size:14px; margin-top:6px; }

    footer{
      position:fixed; left:0; right:0; bottom:0;
      background: linear-gradient(90deg,var(--accent-blue),#06607f);
      color:#fff; padding:12px 18px; text-align:center; font-weight:600;
      box-shadow: 0 -6px 22px rgba(2,22,40,0.08);
    }

    /* helpers */
    .center{ display:flex; justify-content:center; align-items:center; }
    .muted-small{ font-size:13px; color:var(--muted); }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <header>
    <!-- small clickable logo (slightly lowered) -->
    <img id="siteLogo" src="GMN Logo.png" alt="GMN Logo" class="logo" tabindex="0" title="Gyan Mandala Nepal - Home">
  </header>

  <main>
    <!-- HOME -->
    <section id="homePage" class="page active" aria-labelledby="homeTitle">
      <div class="welcome" role="banner">
        <div id="homeTitle" class="welcome-line w1">Welcome</div>
        <div class="welcome-line w2">to</div>
        <div class="welcome-line w3">Gyan Mandala Nepal</div>
      </div>
      <p class="subtitle center" style="max-width:820px;">
        Engaging lessons, easy navigation and delightful micro-interactions — designed for learners and teachers.
        Start by selecting your class and subject.
      </p>

      <div class="hero-actions">
        <button id="enterPortal" class="btn btn-primary" aria-haspopup="true">Go to Learning Portal</button>
        <button id="demoInfo" class="btn btn-ghost" onclick="alert('Demo: choose class & subject; lessons load automatically.')">How it works</button>
      </div>
    </section>

    <!-- FORM -->
    <section id="formPage" class="page" aria-labelledby="formTitle" tabindex="-1">
      <div class="card" role="region" aria-labelledby="formTitle">
        <h2 id="formTitle">Enter Your Details</h2>
        <p class="muted">Select class (1–10) and the subject. When both selections are chosen we automatically open the lesson page.</p>

        <form id="studentForm" onsubmit="return false;">
          <div class="field full">
            <label for="schoolName">School Name</label>
            <input id="schoolName" type="text" placeholder="e.g., Gyan Mandala Higher School" />
            <div class="muted-small">Optional — stored for this session.</div>
          </div>

          <div class="field">
            <label for="studentName">Student Name</label>
            <input id="studentName" type="text" placeholder="Student name (optional)" />
          </div>

          <div class="field">
            <label for="grade">Class</label>
            <select id="grade" required aria-required="true">
              <option value="">Select class</option>
              <!-- filled by JS -->
            </select>
          </div>

          <div class="field">
            <label for="subject">Subject</label>
            <select id="subject" required aria-required="true">
              <option value="">Select subject</option>
              <!-- dynamic by grade -->
            </select>
          </div>

          <div class="field full center" style="margin-top:12px;">
            <div class="muted-small">Selections will auto-navigate. Use breadcrumb to change choices later.</div>
          </div>
        </form>
      </div>
    </section>

    <!-- LESSONS -->
    <section id="lessonsPage" class="page" aria-labelledby="lessonsTitle" tabindex="-1">
      <div style="max-width:var(--max-width); margin:0 auto;">
        <nav class="breadcrumb" aria-label="Breadcrumb">
          <a id="crumbHome" role="link">Home</a>
          <span>›</span>
          <a id="crumbClass" role="link" style="cursor:pointer;">Class</a>
          <span>›</span>
          <span id="crumbSubject" style="font-weight:700;"></span>
        </nav>

        <!-- NEW: Grade & Subject header above grid -->
        <div id="lessonsHeaderBox" class="lessons-header" role="region" aria-label="Lesson context">
          <div class="left" id="lessonsGrade">Grade: —</div>
          <div class="right" id="lessonsSubject">Subject: —</div>
        </div>

        <div class="lessons-sub" id="lessonsIntro">20 lessons available. Click to preview.</div>

        <div id="lessonsGrid" class="lessons-grid" role="list" aria-labelledby="lessonsTitle" tabindex="0">
          <!-- 20 buttons injected by JS -->
        </div>
      </div>
    </section>
  </main>

  <footer>© 2025 Gyan Mandala Nepal, All Rights Reserved</footer>

  <!-- modal -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Lesson</h3>
      <div class="meta" id="modalMeta">Subject • Class</div>
      <p id="modalBody" style="margin-top:12px;color:#334155;">Demo preview for this lesson. Replace or route to real lesson content as needed.</p>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        <button class="btn btn-primary" onclick="alert('Open full lesson — demo')">Open Lesson</button>
      </div>
    </div>
  </div>

  <script>
    /************************************************************************
     * App state & mapping
     ************************************************************************/
    const state = {
      current: 'home',
      grades: Array.from({length:10}, (_,i) => i+1), // 1..10
      subjectsLow: [ // grades 1-3
        { id:'maths', name:'Mathematics' },
        { id:'english', name:'English' },
        { id:'hamro', name:'Hamro Serophero' },
        { id:'nepali', name:'Nepali' }
      ],
      subjectsHigh: [ // grades 4-10
        { id:'maths', name:'Mathematics' },
        { id:'english', name:'English' },
        { id:'science', name:'Science' },
        { id:'nepali', name:'Nepali' },
        { id:'social', name:'Social Studies' }
      ],
      subjectNames: {
        maths:'Mathematics', english:'English', hamro:'Hamro Serophero',
        nepali:'Nepali', science:'Science', social:'Social Studies'
      }
    };

    const $ = q => document.querySelector(q);
    const $$ = q => Array.from(document.querySelectorAll(q));

    /************************************************************************
     * Page transitions
     ************************************************************************/
    function showPage(pageId){
      const map = { home:'#homePage', form:'#formPage', lessons:'#lessonsPage' };
      if(state.current === pageId) return;
      const from = document.querySelector(map[state.current]);
      const to = document.querySelector(map[pageId]);
      if(from){
        from.classList.remove('active');
        from.classList.add('page-exit');
        setTimeout(()=> from.classList.remove('page-exit'), 360);
      }
      to.classList.add('active','page-enter');
      setTimeout(()=> to.classList.remove('page-enter'),420);
      state.current = pageId;
      setTimeout(()=> to.focus && to.focus(), 200);
    }

    /************************************************************************
     * Session guards (prevent direct access)
     ************************************************************************/
    function setVisitedHome(){ sessionStorage.setItem('visitedHome','1'); }
    function setVisitedForm(){ sessionStorage.setItem('visitedForm','1'); }
    function allowedForm(){ return sessionStorage.getItem('visitedHome') === '1'; }
    function allowedLessons(){ return sessionStorage.getItem('visitedForm') === '1'; }

    /************************************************************************
     * Startup & events
     ************************************************************************/
    document.addEventListener('DOMContentLoaded', ()=> {
      // fill grade dropdown
      const gradeEl = $('#grade');
      state.grades.forEach(g => { const opt = document.createElement('option'); opt.value = g; opt.textContent = `Class ${g}`; gradeEl.appendChild(opt); });

      // Logo click -> home
      $('#siteLogo').addEventListener('click', ()=> { sessionStorage.clear(); navigateHome(); });
      $('#siteLogo').addEventListener('keypress', (e)=> { if(e.key === 'Enter') { sessionStorage.clear(); navigateHome(); } });

      // Portal entry
      $('#enterPortal').addEventListener('click', ()=> { setVisitedHome(); navigateForm(); });

      // crumbs
      $('#crumbHome').addEventListener('click', ()=> { sessionStorage.clear(); navigateHome(); });
      $('#crumbClass').addEventListener('click', ()=> { location.hash = '#form'; showPage('form'); });

      // dynamic subject update on grade change
      $('#grade').addEventListener('change', e => { updateSubjectsForGrade(parseInt(e.target.value)); triggerAutoNav(); });
      $('#subject').addEventListener('change', triggerAutoNav);

      // overlay close on click outside
      $('#overlay').addEventListener('click', (e)=> { if(e.target === $('#overlay')) closeModal(); });
      document.addEventListener('keyup', (e)=> { if(e.key === 'Escape') closeModal(); });

      // protect initial hash
      handleInitialHash();
    });

    /************************************************************************
     * Subject populating based on grade
     ************************************************************************/
    function updateSubjectsForGrade(grade){
      const subj = $('#subject');
      subj.innerHTML = '<option value="">Select subject</option>';
      if(!grade) return;
      const list = grade <= 3 ? state.subjectsLow : state.subjectsHigh;
      list.forEach(s => { const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; subj.appendChild(opt); });
    }

    /************************************************************************
     * Auto-navigate to lessons after both selections
     ************************************************************************/
    let navTimer = null;
    function triggerAutoNav(){
      if(!allowedForm()){ navigateHome(); return; }
      const g = parseInt($('#grade').value);
      const s = $('#subject').value;
      if(g && s){
        if(navTimer) clearTimeout(navTimer);
        navTimer = setTimeout(()=> {
          if(!isValidCombination(g,s)){ alert('Invalid class–subject pairing.'); return; }
          setVisitedForm();
          navigateLessons(g,s);
        }, 360);
      }
    }

    /************************************************************************
     * Validate combination using updated mapping
     ************************************************************************/
    function isValidCombination(grade, subjectId){
      const low = state.subjectsLow.map(x => x.id);
      const high = state.subjectsHigh.map(x => x.id);
      return (grade <= 3) ? low.includes(subjectId) : high.includes(subjectId);
    }

    /************************************************************************
     * Navigation helpers
     ************************************************************************/
    function navigateHome(){ location.hash=''; showPage('home'); }
    function navigateForm(){ if(!allowedForm()){ navigateHome(); return; } location.hash='#form'; showPage('form'); }
    function navigateLessons(grade, subjectId){
      if(!allowedLessons() || !isValidCombination(grade, subjectId)){ navigateHome(); return; }
      location.hash = `#lessons/class-${grade}/${subjectId}`;
      renderLessons(grade, subjectId);
      showPage('lessons');
    }

    /************************************************************************
     * Render lessons grid & header (purely presentational changes requested)
     ************************************************************************/
    function renderLessons(grade, subjectId){
      // header left/right
      $('#lessonsGrade').textContent = `Grade: ${grade}`;
      const subjName = state.subjectNames[subjectId] || subjectId;
      $('#lessonsSubject').innerHTML = `Subject: <span style="font-weight:900;color:var(--accent-red);">${escapeHtml(subjName)}</span>`;

      // subject breadcrumb
      $('#crumbClass').textContent = `Class ${grade}`;
      $('#crumbSubject').textContent = subjName;

      // add subtle subject class to page for styles
      const lessonsPage = $('#lessonsPage');
      lessonsPage.classList.remove('lessonsPage-subject-maths','lessonsPage-subject-english','lessonsPage-subject-science','lessonsPage-subject-social','lessonsPage-subject-nepali','lessonsPage-subject-hamro');
      lessonsPage.classList.add(`lessonsPage-subject-${subjectId}`);

      // grid: 20 buttons with only "Lesson N"
      const grid = $('#lessonsGrid');
      grid.innerHTML = '';
      for(let i=1;i<=20;i++){
        const btn = document.createElement('button');
        btn.className = 'lesson-btn';
        btn.setAttribute('role','listitem');
        btn.setAttribute('aria-label', `Open Lesson ${i}`);
        btn.innerHTML = `Lesson ${i}`;
        // ripple and open modal on click
        btn.addEventListener('click', (e) => {
          ripple(e, btn);
          openModal(grade, subjectId, i);
        });
        // keyboard activates button with Enter/Space
        btn.addEventListener('keydown', (e) => {
          if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
        });
        grid.appendChild(btn);
      }

      window.scrollTo({top:0, behavior:'smooth'});
    }

    /************************************************************************
     * Modal open / close
     ************************************************************************/
    function openModal(grade, subjectId, lessonNum){
      $('#modalTitle').textContent = `Lesson ${lessonNum}`;
      $('#modalMeta').textContent = `${state.subjectNames[subjectId]} • Class ${grade}`;
      $('#modalBody').textContent = `Preview for Lesson ${lessonNum} (demo). Replace with actual lesson content or link to lesson detail pages.`;
      $('#overlay').classList.add('open');
      $('#overlay').setAttribute('aria-hidden','false');
    }
    function closeModal(){
      $('#overlay').classList.remove('open');
      $('#overlay').setAttribute('aria-hidden','true');
    }

    /************************************************************************
     * Ripple effect (subtle) placed in button center
     ************************************************************************/
    function ripple(event, button){
      const circle = document.createElement('span');
      circle.className = 'ripple';
      const rect = button.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      circle.style.width = circle.style.height = size + 'px';
      const x = event.clientX - rect.left - size/2;
      const y = event.clientY - rect.top - size/2;
      circle.style.left = x + 'px';
      circle.style.top = y + 'px';
      button.appendChild(circle);
      setTimeout(()=> circle.remove(), 650);
    }

    /************************************************************************
     * Hash handling & protection for direct links
     ************************************************************************/
    function handleInitialHash(){
      const hash = location.hash || '';
      if(!hash){ navigateHome(); return; }

      if(hash.startsWith('#form')) {
        if(sessionStorage.getItem('visitedHome') === '1'){ showPage('form'); }
        else navigateHome();
        return;
      }

      if(hash.startsWith('#lessons')){
        const parts = hash.replace('#lessons/','').split('/');
        if(parts.length === 2){
          const classPart = parts[0].replace('class-','');
          const subjectId = parts[1];
          const gradeNum = parseInt(classPart);
          if(Number.isInteger(gradeNum) && isValidCombination(gradeNum, subjectId) && sessionStorage.getItem('visitedForm') === '1'){
            renderLessons(gradeNum, subjectId);
            showPage('lessons');
            return;
          }
        }
        navigateHome();
        return;
      }

      navigateHome();
    }

    /************************************************************************
     * Utilities & initial startup
     ************************************************************************/
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

    window.addEventListener('load', ()=> {
      // fill grades & initialize
      state.grades.forEach(g => {
        const opt = document.createElement('option'); opt.value = g; opt.textContent = `Class ${g}`; $('#grade').appendChild(opt);
      });

      // link events already bound in DOMContentLoaded, but ensure initial hash
      handleInitialHash();
    });

    // Expose navigateForm and trigger visited flags via entry button
    document.addEventListener('DOMContentLoaded', ()=> {
      // Portal entry sets visitedHome then shows form
      $('#enterPortal').addEventListener('click', ()=> {
        sessionStorage.setItem('visitedHome','1');
        navigateForm();
      });

      // crumb actions
      $('#crumbHome').addEventListener('click', ()=> { sessionStorage.clear(); navigateHome(); });
      $('#crumbClass').addEventListener('click', ()=> { location.hash = '#form'; showPage('form'); });

      // grade/subject change handlers
      $('#grade').addEventListener('change', (e)=> { updateSubjectsForGrade(parseInt(e.target.value)); });
      $('#subject').addEventListener('change', ()=> { /* handled by triggerAutoNav via earlier binding */ });

      // set up automatic navigation flow
      // guard: only allow form if visitedHome was set
      function navigateForm(){
        if(!allowedForm()){ navigateHome(); return; }
        sessionStorage.setItem('visitedForm','1');
        location.hash = '#form';
        showPage('form');
      }

      // attach the function to global so navigateForm can be used above
      window.navigateForm = navigateForm;

      // auto navigation monitoring (centralized)
      let autoTimer = null;
      function monitorAutoNav(){
        if(!allowedForm()){ navigateHome(); return; }
        const gradeVal = parseInt($('#grade').value);
        const subjectVal = $('#subject').value;
        if(gradeVal && subjectVal){
          if(autoTimer) clearTimeout(autoTimer);
          autoTimer = setTimeout(()=> {
            if(!isValidCombination(gradeVal, subjectVal)){ alert('Invalid class–subject selection.'); return; }
            sessionStorage.setItem('visitedForm','1');
            navigateLessons(gradeVal, subjectVal);
          }, 360);
        }
      }
      // shared handlers
      $('#grade').addEventListener('change', monitorAutoNav);
      $('#subject').addEventListener('change', monitorAutoNav);
    });
  </script>
</body>
</html>
